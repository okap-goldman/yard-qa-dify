# 詳細設計書

## システム構成要素と役割

### 1. Difyプラットフォーム

#### 役割
コアLLM処理（回答生成、RAG検索）やワークフロー管理を担当する。

#### 実装詳細
- Xserver VPS (4GBプラン) 上でDockerコンテナとしてDifyを起動
- Dify管理コンソール: ブラウザ上でのモデル設定・ワークフロー設定可能
- APIエンドポイント: `/api/v1/chat`, `/api/v1/knowledge_base`, `/api/v1/datasets` 等（Difyのガイドラインに準拠）

#### ワークフロー構成例
質問受付 → RAG検索 → 回答生成（Geminiモデル）→ 画像URL挿入 → 回答返却

### 2. ナレッジベース（KB）

#### 役割
マニュアル（Markdown形式）をDifyのKBとして登録し、RAGで利用可能なデータ源にする。

#### Dify KB管理方法
- ナレッジはDifyの"Knowledge Base (Dataset)"として管理
- POST `/api/v1/datasets/{dataset_id}/documents` 等のAPIでMarkdownファイルをアップロード可能
- Difyが自動でドキュメントを分割・ベクトル化し、インデックスを構築
- インデックスは数分程度で更新され、最大1時間以内には反映が保証
- KB統合後、`/api/v1/chat`でRAG検索時にこのインデックスから情報取得

#### メンテナンス
- Dify管理コンソールまたはAPIから、既存ドキュメントの更新・削除が可能
- マニュアル更新時にはVBAマクロ等でAPIにPOSTし、新しいMarkdownドキュメントを再アップロード

### 3. 画像サーバ (Google Drive静的ホスティング)

#### 役割
マニュアル画像をGoogle Driveに配置し、共有可能なパブリックリンク（URL）で参照する。

#### 実装詳細
- 画像ファイルをGoogle Drive上の共有フォルダに配置
- 「共有可能なリンク」を取得し、静的ホスティング用URLとして回答内に埋め込む
- Drive URL例: `https://drive.google.com/uc?export=view&id=<FILE_ID>`

#### 更新手順
マニュアル更新時、新規画像や更新画像をGoogle Driveフォルダにアップロードし、URLをKB更新用Markdown中にコメントまたは参照先として記述

### 4. 認証モジュール

#### 役割
Basic認証によるアクセス制御

#### 実装詳細
- NGINX等のリバースプロキシでBasic認証設定
- Dify UIへのアクセス前に認証要求
- .htpasswdファイルでユーザー管理

### 5. Dify API

#### 役割
KB更新や問い合わせのためのAPI群を提供

#### エンドポイント例
- KB更新（ドキュメントアップロード）: POST `/api/v1/datasets/{dataset_id}/documents`
- チャット問い合わせ: POST `/api/v1/chat`

### 6. KB更新API呼び出し (Excel VBAによる非エンジニア操作)

#### 役割
エクセル上でマニュアル更新を行った担当者が、VBAマクロを実行することで直接Dify APIを呼び出し、Markdownドキュメントをアップロードする。

#### 実装詳細
ExcelファイルにVBAボタンを配置。「更新」ボタンを押すと、以下の処理を行う:

1. Excelシート内のマニュアル情報を抽出
2. Markdownファイル（文字列）を生成（行単位で変換するロジック）
3. VBAでXMLHTTPオブジェクト等を用いてPOST `/api/v1/datasets/{dataset_id}/documents`へMultipartまたはJSONリクエスト送信
4. 成功レスポンス後、ユーザーへメッセージ表示「KB更新完了」

- 認証トークンはあらかじめExcel内に記載（保護シート）または外部設定ファイルで管理
- 更新後、Dify側は自動的にインデックスを再構築し、最大1時間以内に反映

### 7. チャットボットUI (Dify UI)

#### 役割
認証後ユーザーが質問を入力し、回答を受け取るためのフロントエンド

#### 実装詳細
- Dify標準UIまたは軽微なカスタマイズ
- 回答中の画像参照箇所ではGoogle DriveのURLを`<img>`タグとして埋め込み

## データフロー詳細

### 1. ユーザーによる質問フロー

1. ユーザーは`https://chatbot.example.com/`へアクセス
2. Basic認証プロンプト → ユーザID/パスワード認証成功後にDify UI表示
3. ユーザー質問入力 → POST `/api/v1/chat` (Dify API)
4. Difyワークフロー:
   - RAGでKB検索（対象は前回アップロード済みMarkdownドキュメント）
   - LLM (Gemini)で回答生成
   - 回答中の画像参照箇所があればGoogle DriveのURL埋め込み
5. 回答結果をUIへ返却 → ブラウザ上にテキスト＋画像表示

### 2. マニュアル更新フロー (非エンジニア対応)

1. 担当者がエクセルを更新（編集者は非エンジニア）
2. Excel内に用意した「マニュアル更新」ボタンを押下
3. VBAマクロが発動:
   - ExcelデータからMarkdownテキスト生成
   - POST `/api/v1/datasets/{dataset_id}/documents` へAPI呼出し
   - HTTPリクエスト(HTTPS)でBasic AuthまたはToken Authを付与
   - コンテンツタイプはmultipart/form-dataもしくはapplication/json(BASE64エンコードしたMD)
   > Difyドキュメントによると multipart/form-data 形式でMarkdownファイルをアップロード可能
4. 成功レスポンスを受け取り、ユーザーに「更新完了」メッセージ表示
5. Dify内部でインデキシング自動実行。最大1時間以内に新しいKBがRAGに反映

## 非機能要件への対応

### パフォーマンス
- Xserver VPS 4GBプランでDify Docker起動
- 同時20～30ユーザー程度の並行アクセスを想定
- キャッシュやLLMへの並列要求制御で3秒以内応答を目指す

### 信頼性・保守性
- 1時間以内にKB更新を反映するDify機能に準拠
- 更新ログはExcel側マクロとDify APIレスポンスを記録し、万一トラブル時に再アップロード可能

### セキュリティ
- HTTPS対応必須（Xserver SSL設定）
- Basic認証で外部アクセスでも利用可（ID/パスワード管理）
- Dify APIトークン管理(Excel内で保護)

### コスト
- オートスケーリング不要。Xserver VPS単一インスタンス上で運用
- Dify無料枠・Gemini無料枠を活用
- リソース消費が増えた場合はプランアップも検討可能

## Dify KB関連詳細

### KB作成フロー
1. DifyコンソールまたはPOST `/api/v1/datasets`で新規Knowledge Base(Dataset)を作成
2. 返却されたdataset_idを保持
3. POST `/api/v1/datasets/{dataset_id}/documents`でMarkdownをアップロード
4. Difyが自動でDocument分割、Vector化し、検索インデックスを更新

### KB統合・検索
- POST `/api/v1/chat`呼び出し時に、RAGノードでdataset_idを指定
- これによりLLMプロンプト作成時に該当Datasetのドキュメント情報をRAGで取得し回答に統合

### KBメンテナンス
- 追加ドキュメントアップロードで新規情報を追加
- 不要なドキュメントはDELETE `/api/v1/datasets/{dataset_id}/documents/{document_id}`で削除
- Excel VBAでの操作範囲は基本的にアップロードのみを想定。削除は管理者がDifyコンソールから実施可能